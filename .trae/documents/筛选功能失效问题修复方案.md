# 筛选功能失效问题分析报告

## 1. 问题诊断

### 1.1 筛选条件数据流转路径
```
FilterPanel 组件选择筛选条件 → GraphPage 组件状态更新 → useVisualization hook 调用 → apiClient.visualization.get → apiClient.get → 后端 API
```

### 1.2 核心问题定位
通过代码分析，发现**API 客户端无法正确处理数组类型的筛选参数**。当 `useVisualization` hook 将 `nodeTypes` 和 `relationshipTypes` 数组传递给 `apiClient` 时，`apiClient.get` 方法会将整个数组转换为字符串 `[object Object]`，导致后端无法正确解析筛选条件。

## 2. 根本原因分析

### 2.1 代码问题点
**位置**：`/Users/tk/Documents/CodingPlatformNetwork/frontend/lib/api-client.ts:46`

```typescript
Object.entries(params).forEach(([key, value]) => {
  if (value !== undefined && value !== null) {
    url.searchParams.append(key, String(value)); // 问题所在：数组被转换为 "[object Object]"
  }
});
```

### 2.2 后端期望格式
从后端代码 `backend/app/routers/visualization.py` 可知，后端期望接收：
- 逗号分隔的字符串：`nodeTypes=Student,Teacher`
- 或多个相同参数：`nodeTypes=Student&nodeTypes=Teacher`

### 2.3 前端传递格式
当前前端传递的是：
```typescript
{
  nodeTypes: ["Student", "Teacher"],
  relationshipTypes: ["CHAT_WITH"]
}
```

被 `apiClient.get` 转换为：
```
nodeTypes=[object Object]&relationshipTypes=[object Object]
```

## 3. 解决方案

### 3.1 修复 API 客户端的参数处理逻辑

**修改文件**：`/Users/tk/Documents/CodingPlatformNetwork/frontend/lib/api-client.ts`

**修改内容**：更新 `apiClient.get` 方法，使其能够正确处理数组类型的参数：

```typescript
async get<T>(endpoint: string, params?: Record<string, unknown>): Promise<T> {
  const url = new URL(`${API_BASE_URL}${endpoint}`);
  if (params) {
    Object.entries(params).forEach(([key, value]) => {
      if (value !== undefined && value !== null) {
        if (Array.isArray(value)) {
          // 处理数组类型：将数组转换为逗号分隔的字符串
          url.searchParams.append(key, value.join(','));
        } else {
          url.searchParams.append(key, String(value));
        }
      }
    });
  }

  const response = await fetch(url.toString(), {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  });

  return handleResponse<T>(response);
}
```

### 3.2 验证修复效果

**修改后数据流**：
1. 用户选择筛选条件：`nodeTypes = ["Student", "Teacher"]`
2. 调用 `apiClient.visualization.get` 时，参数被转换为：`nodeTypes=Student,Teacher`
3. 后端接收到正确格式的参数，进行数据过滤
4. 返回过滤后的图谱数据，前端正确渲染

## 4. 验证策略

### 4.1 测试步骤

1. **基础功能验证**：
   - 选择单个节点类型（如 "Student"），验证仅显示学生节点
   - 选择多个节点类型，验证显示所有选定类型的节点
   - 选择单个关系类型，验证仅显示该类型的连线
   - 选择多个关系类型，验证显示所有选定类型的连线

2. **边界情况测试**：
   - 取消选择所有节点类型，验证不显示任何节点
   - 取消选择所有关系类型，验证不显示任何连线
   - 组合选择节点类型和关系类型，验证交集结果

3. **交互体验测试**：
   - 验证筛选条件应用后，图表数据实时更新
   - 验证 "重置" 按钮能恢复默认筛选条件
   - 验证 "存为子视图" 功能正常工作

### 4.2 验证工具

- 浏览器开发者工具：检查 API 请求 URL 和参数格式
- 后端日志：查看 API 请求是否正确解析筛选条件
- 前端 UI 验证：确认图表渲染结果符合预期

## 5. 优化建议

### 5.1 状态管理优化
- 考虑将筛选条件状态移至全局状态管理（如 graph-store），便于在多个组件间共享
- 添加筛选条件变更的历史记录，支持撤销/重做功能

### 5.2 性能优化
- 实现筛选条件的防抖处理，避免频繁请求
- 添加筛选结果的缓存机制，提高响应速度

### 5.3 用户体验优化
- 添加筛选条件应用的加载状态提示
- 显示筛选结果的统计信息（如匹配的节点数和连线数）
- 提供预设筛选条件模板，方便用户快速选择

## 6. 预期效果

修复后，筛选功能将能够：
- ✅ 正确处理节点类型筛选
- ✅ 正确处理关系类型筛选  
- ✅ 支持多条件组合筛选
- ✅ 实时更新图表渲染结果
- ✅ 与后端 API 正确交互

该修复方案确保了筛选条件能够正确传递给后端，并应用到图表渲染中，解决了当前筛选功能失效的问题。